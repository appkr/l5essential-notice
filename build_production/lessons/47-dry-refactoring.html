<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <meta name="description" content="필자가 개발한 컴포저 컴포넌트를 이용해서 중복을 한번 더 제거한다."/>
  <meta name="google-site-verification" content="ToXKBimREnz49pDNot4b-N9ZJgYcKXPPsHsjhg4Zzuc"/>
  <meta name="naver-site-verification" content="7cebcc8e5493169f5401870d9ce57f48d18491cd"/>

  <meta name="msapplication-tap-highlight" content="no"/>

  <!-- Facebook Meta -->
  <meta property="og:title" content="라라벨 5 입문 및 실전 / 47강 - 중복 제거 리팩토링"/>
  <meta property="og:type" content="Website"/>
  <meta property="og:author" content="appkr (juwonkim@me.com)"/>
  <meta property="og:image" content=""/>

  <!-- Google+ Meta -->
  <meta itemprop="name" content="라라벨 5 입문 및 실전 / 47강 - 중복 제거 리팩토링">
  <meta itemprop="description" content="필자가 개발한 컴포저 컴포넌트를 이용해서 중복을 한번 더 제거한다.">
  <meta itemprop="image" content="">
  <meta itemprop="author" content="appkr (juwonkim@me.com)"/>

  <!-- Twitter Meta -->
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@appkrs"/>
  <meta name="twitter:title" content="라라벨 5 입문 및 실전 / 47강 - 중복 제거 리팩토링"/>
  <meta name="twitter:description" content="필자가 개발한 컴포저 컴포넌트를 이용해서 중복을 한번 더 제거한다."/>
  <meta name="twitter:image" content=""/>
  <meta name="twitter:domain" content="http://l5.appkr.kr/">

  <!-- Mobile and Rss -->
  <link rel="canonical" href="http://l5.appkr.kr/"/>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/nanumgothic.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons"/>
  <link rel="stylesheet" href="/css/main.css">

  <title>라라벨 5 입문 및 실전 / 47강 - 중복 제거 리팩토링</title>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body id="#app">
  <nav class="navbar navbar-fixed-top role="navigation">

  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="navbar-brand">
        <i class="material-icons">school</i>
        라라벨 5 입문 및 실전
      </a>
    </div>
  </div>
</nav>
  <div class="container">
    <div class="row">
      <aside id="sidebar" class="col-md-3">
        <ul>
                      <li  index="0" current-index="49">
              <a href="/lessons/01-welcome.html">1강 - 처음 만나는 라라벨</a>
            </li>
                      <li  index="1" current-index="49">
              <a href="/lessons/02-hello-laravel.html">2강 - 라라벨 5 설치하기</a>
            </li>
                      <li  index="2" current-index="49">
              <a href="/lessons/02-install-on-windows.html">2강 - 라라벨 5 설치하기 (on Windows)</a>
            </li>
                      <li  index="3" current-index="49">
              <a href="/lessons/03-configuration.html">3강 - 글로벌 설정 살펴보기</a>
            </li>
                      <li  index="4" current-index="49">
              <a href="/lessons/04-routing-basics.html">4강 - Routing 기본기</a>
            </li>
                      <li  index="5" current-index="49">
              <a href="/lessons/05-pass-data-to-view.html">5강 - 뷰에 데이터 바인딩하기</a>
            </li>
                      <li  index="6" current-index="49">
              <a href="/lessons/06-blade-101.html">6강 - 블레이드 101</a>
            </li>
                      <li  index="7" current-index="49">
              <a href="/lessons/07-blade-201.html">7강 - 블레이드 201</a>
            </li>
                      <li  index="8" current-index="49">
              <a href="/lessons/08-raw-queries.html">8강 - 날 쿼리 :(</a>
            </li>
                      <li  index="9" current-index="49">
              <a href="/lessons/09-query-builder.html">9강 - 쿼리 빌더</a>
            </li>
                      <li  index="10" current-index="49">
              <a href="/lessons/10-eloquent.html">10강 - 엘로퀀트 ORM</a>
            </li>
                      <li  index="11" current-index="49">
              <a href="/lessons/11-migration.html">11강 - DB 마이그레이션</a>
            </li>
                      <li  index="12" current-index="49">
              <a href="/lessons/12-controller.html">12강 - 컨트롤러</a>
            </li>
                      <li  index="13" current-index="49">
              <a href="/lessons/13-restful-resource-controller.html">13강 - RESTful 리소스 컨트롤러</a>
            </li>
                      <li  index="14" current-index="49">
              <a href="/lessons/14-named-routes.html">14강 - 이름 있는 Route</a>
            </li>
                      <li  index="15" current-index="49">
              <a href="/lessons/15-nested-resources.html">15강 - 중첩된 리소스</a>
            </li>
                      <li  index="16" current-index="49">
              <a href="/lessons/16-authentication.html">16강 - 사용자 인증 기본기</a>
            </li>
                      <li  index="17" current-index="49">
              <a href="/lessons/17-authentication-201.html">17강 - 라라벨에 내장된 사용자 인증</a>
            </li>
                      <li  index="18" current-index="49">
              <a href="/lessons/18-eloquent-relationships.html">18강 - 모델간 관계 맺기</a>
            </li>
                      <li  index="19" current-index="49">
              <a href="/lessons/19-seeder.html">19강 - 데이터 심기</a>
            </li>
                      <li  index="20" current-index="49">
              <a href="/lessons/20-eager-loading.html">20강 - Eager 로딩</a>
            </li>
                      <li  index="21" current-index="49">
              <a href="/lessons/20-1-pagination.html">추가 - 페이징</a>
            </li>
                      <li  index="22" current-index="49">
              <a href="/lessons/21-mail.html">21강 - 메일 보내기</a>
            </li>
                      <li  index="23" current-index="49">
              <a href="/lessons/22-events.html">22강 - 이벤트</a>
            </li>
                      <li  index="24" current-index="49">
              <a href="/lessons/23-validation.html">23강 - 입력 값 유효성 검사</a>
            </li>
                      <li  index="25" current-index="49">
              <a href="/lessons/24-exception-handling.html">24강 - 예외 처리</a>
            </li>
                      <li  index="26" current-index="49">
              <a href="/lessons/25-composer.html">25강 - 컴포저</a>
            </li>
                      <li  index="27" current-index="49">
              <a href="/lessons/26-document-model.html">26강 - Document 모델</a>
            </li>
                      <li  index="28" current-index="49">
              <a href="/lessons/27-document-controller.html">27강 - Document 컨트롤러</a>
            </li>
                      <li  index="29" current-index="49">
              <a href="/lessons/28-cache.html">28강 - Cache</a>
            </li>
                      <li  index="30" current-index="49">
              <a href="/lessons/29-elixir.html">29강 - Elixir, 만병통치약?</a>
            </li>
                      <li  index="31" current-index="49">
              <a href="/lessons/30-final-touch.html">30강 - Debug &amp; Final Touch</a>
            </li>
                      <li  index="32" current-index="49">
              <a href="/lessons/31-forum-features.html">31강 - 포럼 요구사항 기획</a>
            </li>
                      <li  index="33" current-index="49">
              <a href="/lessons/32-login.html">32강 - 사용자 로그인</a>
            </li>
                      <li  index="34" current-index="49">
              <a href="/lessons/33-social-login.html">33강 - 소셜 로그인</a>
            </li>
                      <li  index="35" current-index="49">
              <a href="/lessons/34-role.html">34강 - 사용자 역할</a>
            </li>
                      <li  index="36" current-index="49">
              <a href="/lessons/35-locale.html">35강 - 다국어 지원</a>
            </li>
                      <li  index="37" current-index="49">
              <a href="/lessons/36-models.html">36강 - 마이그레이션과 모델</a>
            </li>
                      <li  index="38" current-index="49">
              <a href="/lessons/37-articles.html">37강 - Article 기능 구현</a>
            </li>
                      <li  index="39" current-index="49">
              <a href="/lessons/38-tags.html">38강 - Tag 기능 구현</a>
            </li>
                      <li  index="40" current-index="49">
              <a href="/lessons/39-attachments.html">39강 - Attachment 기능 구현</a>
            </li>
                      <li  index="41" current-index="49">
              <a href="/lessons/32n33-auth-refactoring.html">32/33 보충 - 인증 리팩토링</a>
            </li>
                      <li  index="42" current-index="49">
              <a href="/lessons/40-comments.html">40강 - Comment 기능 구현</a>
            </li>
                      <li  index="43" current-index="49">
              <a href="/lessons/41-ui-makeup.html">41강 - UI 개선</a>
            </li>
                      <li  index="44" current-index="49">
              <a href="/lessons/42-be-makeup.html">42강 - 서버 사이드 개선</a>
            </li>
                      <li  index="45" current-index="49">
              <a href="/lessons/43-change-note.html">43강 - 변경 사항 알림</a>
            </li>
                      <li  index="46" current-index="49">
              <a href="/lessons/44-api-basic.html">44강 - API 기본기 및 기획</a>
            </li>
                      <li  index="47" current-index="49">
              <a href="/lessons/45-api-big-picture.html">45강 - 기본 구조 잡기</a>
            </li>
                      <li  index="48" current-index="49">
              <a href="/lessons/46-jwt.html">46강 - JWT 를 이용한 인증</a>
            </li>
                      <li class="active" index="49" current-index="49">
              <a href="/lessons/47-dry-refactoring.html">47강 - 중복 제거 리팩토링</a>
            </li>
                      <li  index="50" current-index="49">
              <a href="/lessons/48-all-is-bad.html">48강 - all() is bad</a>
            </li>
                      <li  index="51" current-index="49">
              <a href="/lessons/49-rate-limit.html">49강 - API Rate Limit</a>
            </li>
                      <li  index="52" current-index="49">
              <a href="/lessons/50-id-obfuscation.html">50강 - 리소스 id 난독화</a>
            </li>
                      <li  index="53" current-index="49">
              <a href="/lessons/51-cors.html">51강 - CORS</a>
            </li>
                      <li  index="54" current-index="49">
              <a href="/lessons/52-caching.html">52강 - Caching</a>
            </li>
                      <li  index="55" current-index="49">
              <a href="/lessons/53-partial-response.html">53강 - Partial Response</a>
            </li>
                      <li  index="56" current-index="49">
              <a href="/lessons/54-api-docs.html">54강 - API Documents</a>
            </li>
                      <li  index="57" current-index="49">
              <a href="/lessons/02-install-homestead-osx.html">Homestead 설치 (on Mac)</a>
            </li>
                      <li  index="58" current-index="49">
              <a href="/lessons/02-install-homestead-windows.html">Homestead 설치 (on Windows)</a>
            </li>
                      <li  index="59" current-index="49">
              <a href="/lessons/999-code-release.html">코드 배포</a>
            </li>
                  </ul>
      </aside>

      <div class="col-md-9">
        <article id="article">
                      <nav id="pagination">
  <ul class="pager pager-top">
    <li class="previous ">
      <a href="/lessons/46-jwt.html">
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_left</i>
        </span>
        <span class="pager-title">
          46강 - JWT 를 이용한...
        </span>
      </a>
    </li>
    <li class="next ">
      <a href="/lessons/48-all-is-bad.html">
        <span class="pager-title">
          48강 - all() is bad
        </span>
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_right</i>
        </span>
      </a>
    </li>
  </ul>
</nav>
            <hr/>

            <h1>실전 프로젝트 3 - RESTful API</h1>
<h2>47강 - 중복 제거 리팩토링</h2>
<p>앞 강에서 기존 컨트롤러의 HTTP 응답 메소드 부분을 API 관련 컨트롤러에서 오버라이드하는 과정에서, 상당히 많은 중복을 보았을 것이다. 이 중복을 제거하는 작업을 이번 강좌에서 해 볼 것이다.  </p>
<h3>API Response 패키지</h3>
<p>API Response 에서 중복을 피하고 Response Payload 를 좀 더 편리하게 만들 수 있는, 이 실전 프로젝트 규모에 적절한 패키지를 찾아 봤지만.. 못 찾았다. <code>App\Http\Controllers\Controller</code> 나 별도 Trait 로 API Response 를 위한 공용 메소드를 정의하는 방법이 있기도 하지만, 필자가 <a href="https://packagist.org/">Packagist</a> 에 올려 놓은 <a href="https://github.com/appkr/api"><code>appkr/api</code></a> 패키지를 이용하도록 하자. </p>
<p><strong><code>참고</code></strong> Laravel/Lumen 월드에서 API 관련 패키지 중에서는 <a href="https://github.com/dingo/api"><code>dingo/api</code></a> 가 갑 (甲) 인데, 라라벨의 네이티브 클래스들을 꽤 많이 오버라이드하고 있어서 사용법을 다시 익혀야 하는 단점이 있다. <a href="45-api-big-picture.md">45강 - 기본 구조 잡기</a> 서두에서 같이 고민했던 &quot;단일 서버 vs. 복수 서버&quot; 섹션을 기억할 것이다. <code>dingo/api</code> 는 API 전용 독립 서버, 즉 복수 서버 구조에 더 적합하다고 생각된다. 거의 라라벨 프레임웍 수준의 큰 프로젝트로 API 관련 a-Z 를 모두 담고 있고, 베스트 프랙티스를 실천하고 있으므로 꼭 한번 설치해서 사용해 보기 바란다.</p>
<h4>설치</h4>
<pre><code class="language-bash">$ composer require "appkr/api:0.1.*"</code></pre>
<p>ServiceProvider 를 설정하고 config 파일을 우리 프로젝트 안으로 끌고 오자. </p>
<pre><code class="language-php">// config/app.php

'providers' =&gt; [
    // ...
    Appkr\Api\ApiServiceProvider::class,
],</code></pre>
<pre><code class="language-bash">$ php artisan vendor:publish --provider="Appkr\Api\ApiServiceProvider"</code></pre>
<h4>설정</h4>
<p>설정 파일을 확인해 보자.</p>
<pre><code class="language-php">// config/fractal.php

return [
    'pattern' =&gt; 'v1/*',
    'domain'  =&gt; 'api.myproject.dev',

    // ...

    'successFormat' =&gt; [
        'success' =&gt; [
            'code'    =&gt; ':code',
            'message' =&gt; ':message',
        ]
    ],

    'errorFormat' =&gt;  [
        'error' =&gt; [
            'code'    =&gt; ':code',
            'message' =&gt; ':message',
        ]
    ],
];</code></pre>
<p><code>pattern</code>, <code>domain</code>
:   이 패키지에서도 <code>is_api_request()</code> 란 Helper 를 포함하고 있는데, 이 Helper 에서 사용하는 설정 값들이다. 주의할 점은 이 패키지가 먼저 로드되고 난후, 우리가 정의한 Helper 가 로드되는데, 이 때 <code>function_exists()</code> 에 걸려서 우리 Helper 가 로드되지 않고,이 패키지의 <code>is_api_request()</code> 가 동작하게 된다는 점이다. PHP 네임스페이스가 필요한 이유를 방금 봤다.</p>
<p><code>successFormat</code>
:   200 번 대의 성공 응답을 할 때, 이 포맷이 사용된다. <code>:code</code>, <code>:message</code> 는 <code>Appkr\Api\Response</code> 클래스의 HTTP 응답 메소드에서 HTTP Status Code 와 메소드에 넘긴 메시지로 치환된다.</p>
<p><code>errorFormat</code>
:   400 번 이상의 에러 응답을 할 때, 이 포맷이 사용된다.</p>
<h3>리팩토링</h3>
<p>방금 끌어온 <code>appkr/api</code> 패키지에서는 <code>json(array $payload)</code> Helper 를 제공한다. 또, <code>json()</code> Helper 는 인자 없이 호출할 때는 <code>Appkr\Api\Response</code> 인스턴스를 리턴하기 때문에, 해당 클래스에 정의된 </p>
<ul>
<li><code>success(string $message)</code></li>
<li><code>error(string|array|\Exception $message)</code></li>
<li><code>respond***(string $message)</code></li>
<li><code>setStatusCode(int $statusCode)</code></li>
<li><code>setMeta(array $meta)</code> </li>
<li><code>...</code></li>
</ul>
<p>등 다양한 메소드를 <code>json()-&gt;success()</code> 처럼 체인해서 사용할 수 있다. <code>set*()</code> 메소드는 다른 응답 메소드보다 먼저 체인되어야 한다는 점을 주의하자. </p>
<h4>컨트롤러</h4>
<p>하나씩 적용해 보자. <code>json(array $payload)</code> Helper 는 <code>response()-&gt;json(array $payload)</code> 와 같은 역할을 한다.</p>
<pre><code class="language-php">// app/Http/Controllers/Api/WelcomeController.php

class WelcomeController extends Controller
{
    /**
     * Get the index page
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function index()
    {
        return json([
            'name'    =&gt; 'myProject Api',
            'message' =&gt; 'Welcome to myProject Api. This is a base endpoint.',
            'version' =&gt; 'n/a',
            'links'   =&gt; [/* ... */],
        ]);
    }
}</code></pre>
<p><code>unprocessableError(mixed $message)</code> 메소드는 HTTP 응답 코드를 422 로 설정하고, 인자로 넘겨 받은 <code>$message</code> 를, <code>config('fractal.errorFormat')</code> 으로 정의한 형태로 치환해서 HTTP 응답을 내 보내는 역할을 한다.</p>
<p><code>setMeta(array $meta)</code> 는 HTTP 응답을 위한 Payload 에 <code>['meta' =&gt; $meta]</code> 를 추가해 준다. </p>
<p><code>created(string|array|Illuminate\Database\Eloquent\Model $primitive)</code> 는 HTTP 응답 코드를 201 로 설정하고, 인자로 넘겨 받은 <code>$primitive</code> 의 형태에 따라 적절하게 포맷팅하여 HTTP 응답을 내보내는 일을 한다.</p>
<pre><code class="language-php">// app/Http/Controllers/Api/UsersController.php

class UsersController extends ParentController
{
    // ...

    protected function respondValidationError(Validator $validator)
    {
        return json()-&gt;unprocessableError($validator-&gt;errors()-&gt;all());
    }

    protected function respondCreated(User $user)
    {
        return json()-&gt;setMeta(['token' =&gt; \JWTAuth::fromUser($user)])-&gt;created();
    }
}</code></pre>
<p><img src="./images/47-dry-fefactoring-img-01.png" alt="" /></p>
<p><code>SessionsController</code> 에서 위와 중복된 메소드는 설명을 생략했다.</p>
<p><code>unauthorizedError(mixed $message)</code> 는 HTTP 응답 코드를 401로 설정하고, 넘겨 받은 <code>$message</code> 를 포맷팅해서 HTTP 응답을 반환한다.</p>
<pre><code class="language-php">// app/Http/Controllers/Api/SessionsController.php

class SessionsController extends ParentController
{
    // ...

    protected function respondLoginFailed()
    {
        return json()-&gt;unauthorizedError('invalid_credentials');
    }
}</code></pre>
<p><img src="./images/47-dry-fefactoring-img-02.png" alt="" /></p>
<p><code>PasswordsController::respondError()</code> 는 어떤 에러가 넘어올 지 모르기 때문에, <code>notFoundError(mixed $message)</code> 를 쓰지 않고, 좀 더 일반적인 <code>error()</code> 메소드를 사용하였다. </p>
<p><code>setStatusCode(int $statusCode)</code> 는 HTTP 응답 코드를 셋팅하는 역할을 한다. <code>error()</code> 메소드에는 'not_found' 란 스트링을 인자로 넘겨 주었다. </p>
<pre><code class="language-php">// app/Http/Controllers/Api/PasswordsController.php

class PasswordsController extends ParentController
{
    // ...

    protected function respondError($message, $statusCode = 400)
    {
        return json()-&gt;setStatusCode($statusCode)-&gt;error('not_found');
    }
}</code></pre>
<p><img src="./images/47-dry-fefactoring-img-03.png" alt="" /></p>
<p><code>App\Http\Controllers\Api\V1\ArticlesController</code> 는 좀 더 다른 형태의 메소드를 사용해야 하기에, 다음 강좌에서 살펴 보기로 하자.</p>
<h4>Handler</h4>
<p>이번에는 라라벨의 글로벌 Exception Handling 을 하는 'App\Exceptions\Handler' 클래스에 끌어온 Response 의 메소드들을 적용하자.</p>
<pre><code class="language-php">class Handler extends ExceptionHandler
{
    public function render($request, Exception $e)
    {
        // ...

        if (is_api_request()) {
            // ...

            return json()-&gt;setStatusCode($code ?: 400)-&gt;error($message);
        }
    }
}</code></pre>
<p><img src="./images/47-dry-fefactoring-img-04.png" alt="" /></p>
<!--@start-->
<hr />
<ul>
<li><a href="../readme.md">목록으로 돌아가기</a></li>
<li><a href="46-jwt.md">46강 - JWT 를 이용한 인증</a></li>
<li><a href="48-all-is-bad.md">48강 - all() is bad</a>
<!--@end--></li>
</ul>

            <hr/>

            <nav id="pagination">
  <ul class="pager pager-bottom">
    <li class="previous ">
      <a href="/lessons/46-jwt.html">
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_left</i>
        </span>
        <span class="pager-title">
          46강 - JWT 를 이용한...
        </span>
      </a>
    </li>
    <li class="next ">
      <a href="/lessons/48-all-is-bad.html">
        <span class="pager-title">
          48강 - all() is bad
        </span>
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_right</i>
        </span>
      </a>
    </li>
  </ul>
</nav>                  </article>

        <hr class="divider">

        <div id="comment">
          <div class="comments" style="margin-bottom: 30px;">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//l5lessons.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  <!--script id="dsq-count-scr" src="//l5lessons.disqus.com/count.js" async></script-->
</div>        </div>
      </div>
    </div>
  </div>

  <div id="toggler">
    <a href="#" title="Open Menu">
      목록 토글
    </a>
  </div>

  <footer id="footer">
  <div>
    &copy; 2016 &nbsp; <a href="https://github.com/appkr">appkr</a> •
    Built with <a href="http://jigsaw.tighten.co/">Jigsaw</a> •
    Hosted by <a href="https://pages.github.com/">Github</a> •
    <a href="/feed.xml">Rss</a>
  </div>
</footer>

<div id="back-to-top">
  <a href="#" title="Scroll to Top">
    <i class="material-icons">keyboard_arrow_up</i>
  </a>
</div>
  <script src="/js/all.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71112324-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>

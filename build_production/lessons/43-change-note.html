<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <meta name="description" content="소프트 삭제, 댓글 투표 등 처음 기획 의도대로 스택 오버플로의 기능을 따라해 본다. 또 향후 확장성을 위해 리포지토리 패턴을 적용하고, 사용자 정의 콘솔 명령도 만들어 본다."/>
  <meta name="google-site-verification" content="ToXKBimREnz49pDNot4b-N9ZJgYcKXPPsHsjhg4Zzuc"/>
  <meta name="naver-site-verification" content="7cebcc8e5493169f5401870d9ce57f48d18491cd"/>

  <meta name="msapplication-tap-highlight" content="no"/>

  <!-- Facebook Meta -->
  <meta property="og:title" content="라라벨 5 입문 및 실전 / 43강 - 변경 사항 알림"/>
  <meta property="og:type" content="Website"/>
  <meta property="og:author" content="appkr (juwonkim@me.com)"/>
  <meta property="og:image" content=""/>

  <!-- Google+ Meta -->
  <meta itemprop="name" content="라라벨 5 입문 및 실전 / 43강 - 변경 사항 알림">
  <meta itemprop="description" content="소프트 삭제, 댓글 투표 등 처음 기획 의도대로 스택 오버플로의 기능을 따라해 본다. 또 향후 확장성을 위해 리포지토리 패턴을 적용하고, 사용자 정의 콘솔 명령도 만들어 본다.">
  <meta itemprop="image" content="">
  <meta itemprop="author" content="appkr (juwonkim@me.com)"/>

  <!-- Twitter Meta -->
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@appkrs"/>
  <meta name="twitter:title" content="라라벨 5 입문 및 실전 / 43강 - 변경 사항 알림"/>
  <meta name="twitter:description" content="소프트 삭제, 댓글 투표 등 처음 기획 의도대로 스택 오버플로의 기능을 따라해 본다. 또 향후 확장성을 위해 리포지토리 패턴을 적용하고, 사용자 정의 콘솔 명령도 만들어 본다."/>
  <meta name="twitter:image" content=""/>
  <meta name="twitter:domain" content="http://l5.appkr.kr/">

  <!-- Mobile and Rss -->
  <link rel="canonical" href="http://l5.appkr.kr/"/>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/nanumgothic.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons"/>
  <link rel="stylesheet" href="/css/main.css">

  <title>라라벨 5 입문 및 실전 / 43강 - 변경 사항 알림</title>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body id="#app">
  <nav class="navbar navbar-fixed-top role="navigation">

  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="navbar-brand">
        <i class="material-icons">school</i>
        라라벨 5 입문 및 실전
      </a>
    </div>
  </div>
</nav>
  <div class="container">
    <div class="row">
      <aside id="sidebar" class="col-md-3">
        <ul>
                      <li  index="0" current-index="45">
              <a href="/lessons/01-welcome.html">1강 - 처음 만나는 라라벨</a>
            </li>
                      <li  index="1" current-index="45">
              <a href="/lessons/02-hello-laravel.html">2강 - 라라벨 5 설치하기</a>
            </li>
                      <li  index="2" current-index="45">
              <a href="/lessons/02-install-on-windows.html">2강 - 라라벨 5 설치하기 (on Windows)</a>
            </li>
                      <li  index="3" current-index="45">
              <a href="/lessons/03-configuration.html">3강 - 글로벌 설정 살펴보기</a>
            </li>
                      <li  index="4" current-index="45">
              <a href="/lessons/04-routing-basics.html">4강 - Routing 기본기</a>
            </li>
                      <li  index="5" current-index="45">
              <a href="/lessons/05-pass-data-to-view.html">5강 - 뷰에 데이터 바인딩하기</a>
            </li>
                      <li  index="6" current-index="45">
              <a href="/lessons/06-blade-101.html">6강 - 블레이드 101</a>
            </li>
                      <li  index="7" current-index="45">
              <a href="/lessons/07-blade-201.html">7강 - 블레이드 201</a>
            </li>
                      <li  index="8" current-index="45">
              <a href="/lessons/08-raw-queries.html">8강 - 날 쿼리 :(</a>
            </li>
                      <li  index="9" current-index="45">
              <a href="/lessons/09-query-builder.html">9강 - 쿼리 빌더</a>
            </li>
                      <li  index="10" current-index="45">
              <a href="/lessons/10-eloquent.html">10강 - 엘로퀀트 ORM</a>
            </li>
                      <li  index="11" current-index="45">
              <a href="/lessons/11-migration.html">11강 - DB 마이그레이션</a>
            </li>
                      <li  index="12" current-index="45">
              <a href="/lessons/12-controller.html">12강 - 컨트롤러</a>
            </li>
                      <li  index="13" current-index="45">
              <a href="/lessons/13-restful-resource-controller.html">13강 - RESTful 리소스 컨트롤러</a>
            </li>
                      <li  index="14" current-index="45">
              <a href="/lessons/14-named-routes.html">14강 - 이름 있는 Route</a>
            </li>
                      <li  index="15" current-index="45">
              <a href="/lessons/15-nested-resources.html">15강 - 중첩된 리소스</a>
            </li>
                      <li  index="16" current-index="45">
              <a href="/lessons/16-authentication.html">16강 - 사용자 인증 기본기</a>
            </li>
                      <li  index="17" current-index="45">
              <a href="/lessons/17-authentication-201.html">17강 - 라라벨에 내장된 사용자 인증</a>
            </li>
                      <li  index="18" current-index="45">
              <a href="/lessons/18-eloquent-relationships.html">18강 - 모델간 관계 맺기</a>
            </li>
                      <li  index="19" current-index="45">
              <a href="/lessons/19-seeder.html">19강 - 데이터 심기</a>
            </li>
                      <li  index="20" current-index="45">
              <a href="/lessons/20-eager-loading.html">20강 - Eager 로딩</a>
            </li>
                      <li  index="21" current-index="45">
              <a href="/lessons/20-1-pagination.html">추가 - 페이징</a>
            </li>
                      <li  index="22" current-index="45">
              <a href="/lessons/21-mail.html">21강 - 메일 보내기</a>
            </li>
                      <li  index="23" current-index="45">
              <a href="/lessons/22-events.html">22강 - 이벤트</a>
            </li>
                      <li  index="24" current-index="45">
              <a href="/lessons/23-validation.html">23강 - 입력 값 유효성 검사</a>
            </li>
                      <li  index="25" current-index="45">
              <a href="/lessons/24-exception-handling.html">24강 - 예외 처리</a>
            </li>
                      <li  index="26" current-index="45">
              <a href="/lessons/25-composer.html">25강 - 컴포저</a>
            </li>
                      <li  index="27" current-index="45">
              <a href="/lessons/26-document-model.html">26강 - Document 모델</a>
            </li>
                      <li  index="28" current-index="45">
              <a href="/lessons/27-document-controller.html">27강 - Document 컨트롤러</a>
            </li>
                      <li  index="29" current-index="45">
              <a href="/lessons/28-cache.html">28강 - Cache</a>
            </li>
                      <li  index="30" current-index="45">
              <a href="/lessons/29-elixir.html">29강 - Elixir, 만병통치약?</a>
            </li>
                      <li  index="31" current-index="45">
              <a href="/lessons/30-final-touch.html">30강 - Debug &amp; Final Touch</a>
            </li>
                      <li  index="32" current-index="45">
              <a href="/lessons/31-forum-features.html">31강 - 포럼 요구사항 기획</a>
            </li>
                      <li  index="33" current-index="45">
              <a href="/lessons/32-login.html">32강 - 사용자 로그인</a>
            </li>
                      <li  index="34" current-index="45">
              <a href="/lessons/33-social-login.html">33강 - 소셜 로그인</a>
            </li>
                      <li  index="35" current-index="45">
              <a href="/lessons/34-role.html">34강 - 사용자 역할</a>
            </li>
                      <li  index="36" current-index="45">
              <a href="/lessons/35-locale.html">35강 - 다국어 지원</a>
            </li>
                      <li  index="37" current-index="45">
              <a href="/lessons/36-models.html">36강 - 마이그레이션과 모델</a>
            </li>
                      <li  index="38" current-index="45">
              <a href="/lessons/37-articles.html">37강 - Article 기능 구현</a>
            </li>
                      <li  index="39" current-index="45">
              <a href="/lessons/38-tags.html">38강 - Tag 기능 구현</a>
            </li>
                      <li  index="40" current-index="45">
              <a href="/lessons/39-attachments.html">39강 - Attachment 기능 구현</a>
            </li>
                      <li  index="41" current-index="45">
              <a href="/lessons/32n33-auth-refactoring.html">32/33 보충 - 인증 리팩토링</a>
            </li>
                      <li  index="42" current-index="45">
              <a href="/lessons/40-comments.html">40강 - Comment 기능 구현</a>
            </li>
                      <li  index="43" current-index="45">
              <a href="/lessons/41-ui-makeup.html">41강 - UI 개선</a>
            </li>
                      <li  index="44" current-index="45">
              <a href="/lessons/42-be-makeup.html">42강 - 서버 사이드 개선</a>
            </li>
                      <li class="active" index="45" current-index="45">
              <a href="/lessons/43-change-note.html">43강 - 변경 사항 알림</a>
            </li>
                      <li  index="46" current-index="45">
              <a href="/lessons/44-api-basic.html">44강 - API 기본기 및 기획</a>
            </li>
                      <li  index="47" current-index="45">
              <a href="/lessons/45-api-big-picture.html">45강 - 기본 구조 잡기</a>
            </li>
                      <li  index="48" current-index="45">
              <a href="/lessons/46-jwt.html">46강 - JWT 를 이용한 인증</a>
            </li>
                      <li  index="49" current-index="45">
              <a href="/lessons/47-dry-refactoring.html">47강 - 중복 제거 리팩토링</a>
            </li>
                      <li  index="50" current-index="45">
              <a href="/lessons/48-all-is-bad.html">48강 - all() is bad</a>
            </li>
                      <li  index="51" current-index="45">
              <a href="/lessons/49-rate-limit.html">49강 - API Rate Limit</a>
            </li>
                      <li  index="52" current-index="45">
              <a href="/lessons/50-id-obfuscation.html">50강 - 리소스 id 난독화</a>
            </li>
                      <li  index="53" current-index="45">
              <a href="/lessons/51-cors.html">51강 - CORS</a>
            </li>
                      <li  index="54" current-index="45">
              <a href="/lessons/52-caching.html">52강 - Caching</a>
            </li>
                      <li  index="55" current-index="45">
              <a href="/lessons/53-partial-response.html">53강 - Partial Response</a>
            </li>
                      <li  index="56" current-index="45">
              <a href="/lessons/54-api-docs.html">54강 - API Documents</a>
            </li>
                      <li  index="57" current-index="45">
              <a href="/lessons/02-install-homestead-osx.html">Homestead 설치 (on Mac)</a>
            </li>
                      <li  index="58" current-index="45">
              <a href="/lessons/02-install-homestead-windows.html">Homestead 설치 (on Windows)</a>
            </li>
                      <li  index="59" current-index="45">
              <a href="/lessons/999-code-release.html">코드 배포</a>
            </li>
                  </ul>
      </aside>

      <div class="col-md-9">
        <article id="article">
                      <nav id="pagination">
  <ul class="pager pager-top">
    <li class="previous ">
      <a href="/lessons/42-be-makeup.html">
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_left</i>
        </span>
        <span class="pager-title">
          42강 - 서버 사이드...
        </span>
      </a>
    </li>
    <li class="next ">
      <a href="/lessons/44-api-basic.html">
        <span class="pager-title">
          44강 - API 기본기 및...
        </span>
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_right</i>
        </span>
      </a>
    </li>
  </ul>
</nav>
            <hr/>

            <h1>실전 프로젝트 2 - Forum</h1>
<h2>43강 - 변경 사항 알림</h2>
<p>2~3주 정도 다른 일로 쉬는 동안 강좌는 쓰지 못했지만, 코드 변경을 계속 해 왔다. 다음 실전 강좌로 넘어가기 전에, 모든 변경 내용을 설명하지는 못하겠지만, 큰 변경 내용은 정리해서 공유하고자 한다.</p>
<ol>
<li>Article Refactoring 
<ul>
<li>포럼에서 &quot;상단 고정 게시물&quot; 기능을 구현했다. </li>
<li><code>Article</code>, <code>Comment</code> 모델에 <a href="http://laravel.com/docs/eloquent#soft-deleting">Soft Delete</a> 기능을 추가하였다.</li>
<li>댓글에 투표 기능을 추가했다.</li>
</ul></li>
<li>Lesson Refactoring
<ul>
<li>'documents (문서)' 디렉토리, Route 엔드포인트, 뷰 등등을 'lessons (강좌)' 으로 변경했다. 아울러 모델 이름도 <code>Document</code> 에서 <code>Lesson</code> 으로 변경했다.</li>
<li>포럼 뿐 아니라 강좌에서도 댓글을 쓸 수 있도록 수정하였다. 이 과정에서 <code>Lesson</code> 모델 관련 <a href="https://github.com/domnikl/DesignPatternsPHP/tree/master/More/Repository">Repository Pattern</a> 을 적용하는 등 몇 가지 관련 코드들의 수정이 있었다.</li>
<li>강좌에서도 &quot;이전&quot;, &quot;다음&quot; 페이지네이션 기능을 추가하였다.</li>
<li>'lessons (강좌)' 디렉토리에 담긴 마크다운 파일의 내용이 바뀌었을 경우, <code>Lesson</code> 모델과 컨텐츠 동기화를 해 주는 커스텀 Artisan 코맨드를 추가했다. </li>
</ul></li>
<li>라이브 데모 사이트 개설
<ul>
<li>이 강좌의 라이브 데모 사이트를 위해, 랜딩 페이지를 만들고, <a href="http://aws.amazon.com/">Amazon Web Service</a> 에 코드를 배포하였다. </li>
<li>이 과정에서 <a href="http://laravel.com/docs/envoy">Envoy SSH Task Runner</a> 를 사용하였다.</li>
<li>라이브 데모 사이트에서 발생하는 Exception 을 <a href="https://slack.com/"># slack</a> 메시지로 받기 위한 기능을 추가했다. </li>
</ul></li>
</ol>
<p><strong><code>참고</code></strong> 상세한 변경사항은 <a href="https://github.com/appkr/l5essential/commit">Laravel 5 Essential</a> 의 Commit History 에서 확인하시기 바란다.</p>
<h3>1. Article Refactoring</h3>
<h4>상단 고정 게시물 기능 구현</h4>
<p><code>Article</code> 모델에 <code>$pin</code> 속성이 지정되어 있으면, 포럼 목록을 표시할 때 가장 위에 표시하는 식으로 포럼 &quot;상단 고정 게시물&quot; 기능을 구현했다.</p>
<pre><code class="language-php">// DATE_create_articles_table.php

class CreateArticlesTable extends Migration
{
    public function up()
    {
        Schema::create('articles', function (Blueprint $table) {
            // ...
            $table-&gt;boolean('pin')-&gt;default(0);
        }
    }
}</code></pre>
<p>아래 코드에서 <code>orderBy('pin', 'desc')</code>가 추가된 것을 확인하자.</p>
<pre><code class="language-php">// app/Http/Controllers/ArticlesController.php

class ArticlesController extends Controller
{
    protected function filter($request, $query)
    {
        //...
        return $query-&gt;orderBy('pin', 'desc')-&gt;orderBy($sort, $direction);
    }</code></pre>
<p>그리고, <code>$pin</code> 속성은 관리자만 지정하거나 해제할 수 있도록 하였다.</p>
<pre><code class="language-html">&lt;!-- resources/views/articles/partial/form.blade.php --&gt;

&lt;!-- Other view codes... --&gt;
@if ($currentUser and $currentUser-&gt;isAdmin())
  &lt;div class="form-group"&gt;
    &lt;div class="checkbox"&gt;
      &lt;label&gt;
        &lt;input type="checkbox" name="pin" {{ $article-&gt;pin ? 'checked="checked"': ''}}&gt;
        {{ trans('forum.pin') }}
      &lt;/label&gt;
    &lt;/div&gt;
  &lt;/div&gt;
@endif</code></pre>
<h4>Soft Delete 적용 및 댓글에 응용</h4>
<p><a href="http://laravel.com/docs/eloquent#soft-deleting">Soft Delete</a> 란 사용자가 삭제 요청을 하면, DB 에서 레코드를 완전히 삭제하는 것이 아니라, <code>deleted_at</code> 이란 필드에 삭제된 날짜를 넣어 놓는 식으로 동작한다. 마이그레이션에서 <code>deleted_at</code> 필드를 추가하고, Soft Delete 를 적용할 모델에서 라라벨에 제공하는 Trait 만 추가하면 된다.</p>
<pre><code class="language-php">// DATE_create_articles_table.php

class CreateArticlesTable extends Migration
{
    public function up()
    {
        Schema::create('articles', function (Blueprint $table) {
            // ...
            $table-&gt;softDeletes();
        }
    }
}</code></pre>
<p>아래에서 <code>$dates</code> 는 날짜 형식을 <code>Carbon\Carbon</code> 인스턴스로 바꾸어서 보여주기 위한 Accessor 이다. 기본기 <a href="22-events.md">22강 - 이벤트</a> 강좌에서 <code>$last_login</code> 속성을 추가할 때도 사용한 적이 있다. </p>
<pre><code class="language-php">// app/Article.php

use Illuminate\Database\Eloquent\SoftDeletes;

class Article extends Model
{
    use SoftDeletes;

    protected $dates = ['deleted_at'];

    // ...
}</code></pre>
<p>Soft Delete 가 적용되었더라도 엘로퀀트나 쿼리빌더에서는 이전과 동일하게 쿼리하면, 라라벨이 내부적으로 <code>deleted_at == null</code> 인 레코드들만 가져오게 되어 있다. 다만 삭제된 레코드까지도 가져오고 싶다면 <code>withTrashed()</code> 메소드를 체인하면 된다. 아래는 자식 댓글이 있음에도 불구하고, 작성자가 자신의 댓글을 삭제했을 때, &quot;삭제된 댓글&quot; 이라고 표시하기 위한 구현인데, <code>withTrashed()</code> 로 삭제된 댓글까지도 모두 가져오고 있음을 확인할 수 있다.</p>
<pre><code class="language-php">// app/Http/Controllers/ArticlesController.php

class ArticlesController extends Controller
{
    public function show($id)
    {
        $article = Article::with('comments', 'tags', 'attachments', 'solution')-&gt;findOrFail($id);
        $commentsCollection = $article-&gt;comments()-&gt;with('replies')
            -&gt;withTrashed()-&gt;whereNull('parent_id')-&gt;latest()-&gt;get();
        // ...
    }</code></pre>
<p>아래는 <code>Comment</code> 모델의 삭제 구현이다. 자식 댓글이 없으면 <code>forceDelete()</code> 메소드로 DB 에서 완전히 삭제해 버리고, 그렇지 않으면 <code>delete()</code> 메소드로 Soft Delete 한다.</p>
<pre><code class="language-php">// app/Http/Controllers/CommentsController.php

class CommentsController extends Controller
{
    public function destroy(Request $request, $id)
    {
        $comment = Comment::with('replies')-&gt;find($id);

        if ($comment-&gt;replies-&gt;count() &gt; 0) {
            $comment-&gt;delete();
        } else {
            $comment-&gt;forceDelete();
        }

        // ...
    }
}</code></pre>
<p>이제 뷰를 살펴보자. <code>$comment-&gt;trashed()</code> 는 Soft Delete 된 댓글일 경우 <code>true</code> 를 반환한다.</p>
<pre><code class="language-html">&lt;!-- resources/views/comments/index.blade.php --&gt;

@forelse($comments as $comment)
@include('comments.partial.comment', [
  // ...
  'hasChild'  =&gt; count($comment-&gt;replies),
  'isTrashed' =&gt; $comment-&gt;trashed()
])
@empty
@endforelse</code></pre>
<pre><code class="language-html">&lt;!-- resources/views/comments/partial/comment.blade.php --&gt;

@if ($isTrashed and ! $hasChild)
  &lt;!-- 자식 댓글이 없는 상태에서 삭제된 댓글 --&gt;
@elseif ($isTrashed and $hasChild)
  &lt;!-- 자식 댓글이 있는데 삭제되었을 때 --&gt;
  &lt;p class="text-danger"&gt;삭제된 댓글입니다.&lt;/p&gt;
@else
  &lt;!-- 삭제되지 않은 댓글일 때 --&gt;
@endif</code></pre>
<h4>댓글에 투표 기능 추가</h4>
<p><a href="https://disqus.com/">Disqus</a>, <a href="http://stackoverflow.com/">Stack Overflow</a> 의 댓글들은 투표시스템 (== 포인팅 시스템) 을 가지고 있고, 그 점수에 따라 댓글의 품질을 평가하고 있다. 여기서도 유사한 기능을 구현했다. 주의할 점은 특정 댓글에 이미 Up 또는 Down 투표를 한 사용자는 같은 댓글에 대해서는 다시 투표를 할 수 없어야 한다는 점이다.</p>
<p>먼저 투표을 받기 위한 마이그레이션과 모델을 만들자. <code>user_id</code> 필드는 이미 투표한 사용자인지를 판단하기 위해서 사용한다. <code>up</code>, <code>down</code> 필드는 특정 <code>comment_id</code> 에 대한 투표 값 통계를 내기 위한 목적으로 각각 분리해서 필드를 생성했다.</p>
<pre><code class="language-php">// DATE_create_votes_table.php

class CreateVotesTable extends Migration
{
    public function up()
    {
        Schema::create('votes', function (Blueprint $table) {
            $table-&gt;increments('id');
            $table-&gt;integer('user_id')-&gt;unsigned();
            $table-&gt;integer('comment_id')-&gt;unsigned();
            $table-&gt;tinyInteger('up')-&gt;nullable();
            $table-&gt;tinyInteger('down')-&gt;nullable();
            $table-&gt;timestamp('voted_at');

            $table-&gt;foreign('user_id')-&gt;references('id')-&gt;on('users')-&gt;onDelete('cascade');
            $table-&gt;foreign('comment_id')-&gt;references('id')-&gt;on('comments')-&gt;onDelete('cascade');
        });
    }
}</code></pre>
<p>아래는 <code>Vote</code> 모델이다. <code>User</code>, <code>Comment</code> 모델에서의 Reverse Relationship 은 설명을 생략한다.</p>
<pre><code class="language-php">// app/Vote.php

class Vote extends Model
{
    public $timestamps = false;

    protected $fillable = [
        'user_id',
        'comment_id',
        'up',
        'down',
        'voted_at',
    ];

    protected $dates = [
        'voted_at',
    ];

    public function comment()
    {
        return $this-&gt;belongsTo(Comment::class);
    }

    public function user()
    {
        return $this-&gt;belongsTo(User::class);
    }
}</code></pre>
<p>이제 투표를 하기 위한 UI 를 만들자. 아래 코드에서 <code>&lt;?php $voted = $comment-&gt;votes-&gt;contains('user_id', $currentUser-&gt;id); ?&gt;</code> 부분을 주목해볼만 하다. 페이지가 로드될 때, 현재 로그인한 사용자가 이미 투표를 했는지 확인하는 부분인데, <code>\Illuminate\Database\Eloquent\Collection::contains(mixed $key, mixed $value = null)</code> API 를 이용하고 있다. 이미 투표했을 경우. <code>@if ($voted) {{ 'disabled="disabled"' }} @endif</code> 에서 버튼을 비활성화시켰다.</p>
<p>투표 값, 'up' 또는 'down' 전송은 Ajax 를 이용하고 있고, 서버에서 성공 응답을 받으면, 투표한 댓글의 투표 버튼을 비활성화 시키고 있다. </p>
<pre><code class="language-html">&lt;!-- resources/views/comments/partial/comment.blade.php --&gt;

@if ($currentUser)
  &lt;div class="btn-group" role="group"&gt;
    &lt;?php $voted = $comment-&gt;votes-&gt;contains('user_id', $currentUser-&gt;id); ?&gt;
    &lt;button type="button" class="btn btn-default btn-sm btn__vote" data-vote="up" title="Vote up" @if ($voted) {{ 'disabled="disabled"' }} @endif&gt;
      {!! icon('up', false) !!} &lt;span&gt;{{ $comment-&gt;up_count }}&lt;/span&gt;
    &lt;/button&gt;
    &lt;button type="button" class="btn btn-default btn-sm btn__vote" data-vote="down" title="Vote down" @if ($voted) {{ 'disabled="disabled"' }} @endif&gt;
      {!! icon('down', false) !!} &lt;span&gt;{{ $comment-&gt;down_count }}&lt;/span&gt;
    &lt;/button&gt;
  &lt;/div&gt;
  &lt;!-- Other view codes... --&gt;
@endif

@section('script')
  
  &lt;script&gt;
    $("button.btn__vote").on("click", function(e) {
      var self = $(this),
          commentId = $(this).closest(".media__item").data("id");

      $.ajax({
        type: "POST",
        url: "/comments/" + commentId + "/vote",
        data: {
          vote: self.data("vote")
        }
      }).success(function(data) {
        self.find("span").html(data.value);
        self.attr("disabled", "disabled");
        self.siblings().attr("disabled", "disabled");
      }).error(function() {
        flash("danger", "{{ trans('common.msg_whoops') }}", 2500);
      });
    });
  &lt;/script&gt;
@stop</code></pre>
<p>이제 뷰에서 Ajax 로 전송한 투표를 받고 처리할 수 있는 Route 와 컨트롤러 로직을 만들어야 한다.</p>
<pre><code class="language-php">// app/Http/routes.php

Route::post('comments/{id}/vote', 'CommentsController@vote');</code></pre>
<p>아래는 컨트롤러이다. 주석에 설명을 달았다.</p>
<pre><code class="language-php">// app/Http/Controllers/CommentsController.php

class CommentsController extends Controller
{
    public function vote(Request $request, $id)
    {
        $this-&gt;validate($request, [
            'vote' =&gt; 'required|in:up,down',
        ]);

        if(Vote::whereCommentId($id)-&gt;whereUserId($request-&gt;user()-&gt;id)-&gt;exists()) {
            // 사용자가 브라우저의 Inspector 등을 이용해서 disabled 된 투표 버튼을 다시 활성화시켜
            // 중복 투표를 하는 것을 방지하기 위한 조치이다.
            return response()-&gt;json(['errors' =&gt; 'Already voted!'], 409);
        }

        $comment = Comment::findOrFail($id);
        $up = $request-&gt;input('vote') == 'up' ? true : false;

        $comment-&gt;votes()-&gt;create([
            'user_id'  =&gt; $request-&gt;user()-&gt;id,
            'up'       =&gt; $up ? 1 : null,
            'down'     =&gt; $up ? null : 1,
            'voted_at' =&gt; \Carbon\Carbon::now()-&gt;toDateTimeString(),
        ]);

        return response()-&gt;json([
            // up, down 어떤 투표인지와 투표 후 총 투표 수를 반환하고,
            // 뷰의 자바스크립트에서 총 투표 수를 업데이트한다.
            'voted' =&gt; $request-&gt;input('vote'),
            'value' =&gt; $comment-&gt;votes()-&gt;sum($request-&gt;input('vote'))
        ]);
    }
}</code></pre>
<p>아래 <code>Comment</code> 모델에서 <code>$with</code> 속성은 모든 쿼리에서 포함할 Eager Loading 관계이다. 즉, <code>Comment::find(1)</code> 로만 쿼리해도 <code>Comment::with('author', 'votes')-&gt;find(1)</code> 과 같은 결과를 보여준다는 의미이다.</p>
<pre><code class="language-php">// app/Comment.php

class Comment extends Model
{
    protected $with = [ 'author', 'votes', ];

    protected $appends = [ 'up_count', 'down_count' ];

    public function getUpCountAttribute()
    {
        return (int) static::votes()-&gt;sum('up');
    }

    public function getDownCountAttribute()
    {
        return (int) static::votes()-&gt;sum('down');
    }

    // ...
}</code></pre>
<p>투표를 포함한 댓글 목록을 브라우저 쪽으로 던져 주는 부분은 <code>ArticlesController::show()</code> 메소드인데 설명은 생략한다. 대신, 사용자로 부터 얻은 댓글에 대한 통계를 어떻게 얻는지를 설명하기로 한다.</p>
<p><code>Comment</code> 모델에서 <code>up_count</code> 와 <code>down_count</code> 란 필드를 동적으로 생성하고 모델의 속성으로 Append 하였다. 이 속성들은 <code>getUpCountAttribute()</code>, <code>getDownCountAttribute()</code> 란 메소드에서 그 값이 채워지는데, <code>Comment::votes()-&gt;sum(up)</code> 처럼 엘로퀀트 컬렉션에서 제공하는 통계 메소드인 <code>sum()</code> 을 이용하고 있다. 앞 전에 <code>Vote</code> 모델을 채울 때, <code>up</code> 과 <code>down</code> 속성에 <code>null|1</code> 을 채운 것이 여기서 모두 합해 지는 것이다.</p>
<pre><code class="language-bash">$ php artisan tinker
&gt;&gt;&gt; $comment = App\Comment::find(22);
=&gt; App\Comment {#835
     content: "저는 자식 댓글입니다.",
     #...,
     author: App\User {#840
       name: "Rowena Ferry",
       #...,
     },
     votes: Illuminate\Database\Eloquent\Collection {#838
       all: [
         App\Vote {#843
           up: 1,
           #...,
         },
         App\Vote {#844
           up: 1,
           #...,
         },
       ],
     },
   }
&gt;&gt;&gt; $comment-&gt;up_count;
=&gt; 2
&gt;&gt;&gt; $comment-&gt;down_count;
=&gt; 0</code></pre>
<p><img src="./images/43-change-note-img-01.png" alt="" /></p>
<h3>2. Lesson Refactoring</h3>
<h4>Repository 구현</h4>
<p>강좌에서도 댓글을 쓸 수 있도록 하기 위해서, <a href="28-cache.md">28강 - Cache</a> 에서 살펴본 바와 유사하게, 사용자의 마크다운 파일 요청이 있으면, 파일시스템에 있던 파일을 읽어서 바로 주는 것이 아니라 DB 에 넣었다. 즉, 파일의 내용을 DB 에 넣어서, 모델을 만들었다는 얘기다. 단, 매번 파일시스템 -&gt; DB Insert 식으로 동작하는 것이 아니라, 캐시처럼 DB 를 먼저 탐색해서 없으면 파일시스템에서 읽어서 DB Insert 하는 식으로 구현했다.</p>
<p>먼저 파일로 부터 읽어 들인 마크다운 파일의 내용을 담을 DB 마이그레이션을 만들어야 한다.</p>
<pre><code class="language-php">// DATE_create_lessons_table.php

class CreateLessonsTable extends Migration
{
    public function up()
    {
        Schema::create('lessons', function (Blueprint $table) {
            $table-&gt;increments('id');
            $table-&gt;integer('author_id')-&gt;unsigned();
            $table-&gt;string('name');
            $table-&gt;text('content');
            $table-&gt;timestamps();
            $table-&gt;foreign('author_id')-&gt;references('id')-&gt;on('users');
        });
    }
}</code></pre>
<p>여러가지 구조를 고민하다가, 강좌 외에도 마크다운 형식의 파일을 서비스할 일이 더 있을 것을 고려해서 Repository 를 만들기로 했다. 아래 코드에서 <code>find()</code> 메소드를 보면, 사용자가 요청한 파일 이름으로 먼저 DB 쿼리를 하고, 쿼리 결과가 <code>null</code> 이면 파일 시스템에서 읽어서 <code>Lesson</code> 모델을 생성하고 있는 것을 확인할 수 있다.</p>
<pre><code class="language-php">// app/Repositories/MarkdownRepository.php

use Exception;
use File;
use Illuminate\Database\Eloquent\Model;

abstract class MarkdownRepository implements RepositoryInterface
{
    protected $model;

    protected $path;

    public function __construct()
    {
        $this-&gt;initialize();
    }

    public abstract function model();

    protected function initialize()
    {
        $model = app()-&gt;make($this-&gt;model());

        if (! $model instanceof Model) {
            throw new Exception(
                'model() method must return a string name of an Eloquent Model.'
            );
        }

        if (! property_exists($this-&gt;model(), 'path')) {
            throw new Exception(
                "{$this-&gt;model()} should have a property named 'path'"
            );
        }

        $path  = base_path($model::$path);

        if (! File::isDirectory($path)) {
            throw new Exception(
                "Something went wrong with the path property of {$this-&gt;model()} model."
            );
        }

        $this-&gt;model = $model;
        $this-&gt;path  = $path;
    }

    public function find($id, $columns = ['*'])
    {
        return $this-&gt;model-&gt;whereName($id)-&gt;first()
            ?: $this-&gt;model-&gt;create([
                // Bad!! Avoid hard code, b.c, admin may change.
                'author_id' =&gt; 1, 
                'name'      =&gt; $id,
                'content'   =&gt; File::get($this-&gt;getPath($id)),
            ]);
    }

    public function image($file) { // ... }

    public function etag($file) { // ... }

    protected function getPath($file)
    {
        $path = $this-&gt;path . DIRECTORY_SEPARATOR . $file;

        if (!File::exists($path)) {
            abort(404, 'File not exist');
        }

        return $path;
    }
}</code></pre>
<p>이 추상 클래스를 상속하는 클래스는 <code>public abstract function</code> 으로 지정한 <code>model()</code> 메소드를 반드시 구현해야 한다. 그리고, 해당 Repository 와 연결된 모델에서는 <code>$path</code> 속성을 제공해야 한다. 이 클래스를 상속하게 되는 <code>LessonRepository</code> 와 <code>Lesson</code> 모델을 차례로 볼 것이다.</p>
<pre><code class="language-php">// app/Repositories/LessonRepository.php

class LessonRepository extends MarkdownRepository
{
    public function model()
    {
        return \App\Lesson::class;
    }
}</code></pre>
<pre><code class="language-php">// app/Lesson.php

class Lesson extends Model
{
    public static $path = 'lessons';

    // ...
}</code></pre>
<p><code>MarkdownRepository</code> 추상 클래스에서 <code>initialize()</code> 메소드의 구동을 살펴보자.</p>
<ul>
<li>먼저 <code>app()-&gt;make(string $abstract)</code> Helper 를 이용해서, <code>Lesson</code> 모델을 생성한다. <code>LessonRepository::model()</code> 메소드에서 <code>\App\Lesson</code> 이란 스트링을 반환하게 되어 있으므로, 당연히 전술한 코드는 <code>app()-&gt;make('\App\Lesson')</code> 와 같이 된다.</li>
<li>좀 전에 만든 클래스가 엘로퀀트 모델이 맞는지를 체크하여 아닐 경우 <code>\Exception</code> 을 던진다</li>
<li><a href="http://php.net/manual/kr/function.property-exists.php"><code>property_exists(mixed $class, string $property)</code></a> PHP 내장 함수로, <code>Lesson</code> 모델에 <code>$path</code> 속성이 지정되어 있지 않을 경우, <code>\Exception</code> 을 던진다.</li>
<li>또, <code>Lesson</code> 모델에서 <code>$path</code> 속성으로 지정한 디렉토리가 존재하지 않을 경우 <code>\Exception</code> 을 던진다.</li>
<li>모든 체크 과정이 완료되면, 이 추상 클래스가 동작하기 위해 필요한 <code>$model</code>, <code>$path</code> 속성이 모두 준비된다.</li>
</ul>
<p>이제 <code>LessonsController</code> 에서 만들어진 <code>LessonRepository</code> 를 사용하면 된다. </p>
<pre><code class="language-php">// app/Controllers/LessonsController

class LessonsController extends Controller
{
    protected $repo;

    public function __construct(LessonRepository $repo)
    {
        // LessonRepository 를 Injection 하고 $repo 속성에 할당한다.
        $this-&gt;repo = $repo;
    }

    public function show($file = '01-welcome.md')
    {
        $lesson = $this-&gt;repo-&gt;find($file);

        $commentsCollection = $lesson-&gt;comments()-&gt;with('replies')
            -&gt;withTrashed()-&gt;whereNull('parent_id')-&gt;latest()-&gt;get();

        return view('lessons.show', [
            'index'           =&gt; $this-&gt;repo-&gt;index(),
            'lesson'          =&gt; $lesson,
            'comments'        =&gt; $commentsCollection,
            'commentableType' =&gt; $this-&gt;repo-&gt;model(),
            'commentableId'   =&gt; $lesson-&gt;id,
        ]);
    }

    // ...
}</code></pre>
<p>강좌에서도 댓글을 사용하기 위해 <code>$comments</code> 변수를 뷰로 넘기는 것이 보일 것이다.</p>
<h4>Pagination</h4>
<p>포럼 목록보기에서 <code>\Illuminate\Database\Eloquent\Collection</code> 을 이용해서 페이지네이션을 보여주었다면, 강좌에서는 단일 강좌 상세보기를 보여주고 있으므로 &quot;다음&quot; 또는 &quot;이전&quot; 강좌로 이동하는 페이지네이션이 적절할 것으로 생각된다. </p>
<p><code>MarkdownRepository</code> 에 페이지네이션에 필요한 기능을 구현하였다. <code>$toc</code> 는 전체 강좌 목록을 가진 배열이다. <code>$current</code> 는 현재 선택된 강좌의 배열 값 (== 파일이름) 이다. <code>$toc</code> 는 <code>initialize()</code> 과정에서 셋팅이되며, <code>$current</code> 는 <code>find()</code> 메소드에서 셋팅이 된다. </p>
<p><code>$toc</code> 를 셋팅하는 과정에 <a href="http://php.net/manual/kr/function.glob.php"><code>glob()</code></a>, <a href="http://php.net/manual/kr/function.array-diff.php"><code>array_diff()</code></a>, <a href="http://php.net/manual/kr/function.array-map.php"><code>array_map()</code></a>, <a href="http://php.net/manual/kr/function.pathinfo.php"><code>pathinfo()</code></a> 등의 PHP 내장 함수를 사용하는데, 공식 문서들을 참고하자.</p>
<p><code>prev(string $current)</code>, <code>next(string $current)</code> 메소드는 모두 <code>$current</code> 를 인자로 받는데, 이는 현재 화면에 표시된 강좌의 마크다운 파일이름이다. 이 메소드들에서는 <a href="http://php.net/manual/kr/function.array-search.php"><code>array_search()</code></a> PHP 내장 함수를 이용해서, 인자로 넘겨 받은 <code>$current</code> 에 해당하는 배열 인덱스를 <code>$toc</code> 에서 찾은 후, +1 또는 -1 해서 원하는 인덱스에 해당하는 파일이름을 반환하게 구현되어 있다. <a href="http://php.net/manual/kr/function.array-key-exists.php"><code>array_key_exists()</code></a> 도 찾아보기 바란다.</p>
<pre><code class="language-php">// app/Repositories/MarkdownRepository.php

abstract class MarkdownRepository implements RepositoryInterface
{
    protected $toc;

    protected $current;

    public function __construct() {// ...}

    protected function initialize()
    {
        if (! $this-&gt;toc) {
            $all    = glob(base_path($model::$path . DIRECTORY_SEPARATOR . '*.md'));
            $except = glob(base_path($model::$path . DIRECTORY_SEPARATOR . '*INDEX.md'));
            // $files 는 INDEX.md 를 제외한 나머지 *.md 파일들을 담고 있는 배열이다.
            $files  = array_diff($all, $except);

            $this-&gt;toc = array_map(function($file) {
                // $files 배열을 순회하면서, $this-&gt;toc 에 담는다.
                return pathinfo($file, PATHINFO_BASENAME);
            }, $files);
        }
    }

    public function find($id, $columns = ['*'])
    {
        // $id 는 '01-welcome.md' 와 같은 파일 이름을 담고 있다.
        $this-&gt;current = $id;

        // ...
    }

    public function prev($current) {
        // $current 가 '01-welcome.md' 라면,
        // array_search 의 결과는 이 파일의 index 인 0 이 된다.
        // $prev 에는 -1 이 할당된다.
        $prev = array_search($current, $this-&gt;toc) - 1;

        // $this-&gt;toc[-1] 은 존재하지 않으므로 false 가 리턴될 것이다.
        return array_key_exists($prev, $this-&gt;toc) ? $this-&gt;toc[$prev] : false;
    }

    public function next($current) {
        // $current 가 '01-welcome.md' 라면,
        // array_search 의 결과는 이 파일의 index 인 0 이 된다.
        // $next 에는 2 가 할당된다.
        $next = array_search($current, $this-&gt;toc) + 1;

        // $this-&gt;toc[2] 에 해당하는 값은 '02-hello-laravel.md' 이다.
        return array_key_exists($next, $this-&gt;toc) ? $this-&gt;toc[$next] : false;
    }

    // ...
}
</code></pre>
<p>이제 쉽다. 컨트롤러에서 뷰에다 &quot;이전&quot;, &quot;다음&quot; 에 해당하는 파일이름을 넘겨주기만 하면 되니까..</p>
<pre><code class="language-php">// app/Http/Controllers/LessonsController.php

class LessonsController extends Controller
{
    public function show($file = '01-welcome.md')
    {
        // ...

        return view('lessons.show', [
            // ...
            'prev'            =&gt; $this-&gt;repo-&gt;prev($file),
            'next'            =&gt; $this-&gt;repo-&gt;next($file),
        ]);
    }
}</code></pre>
<p>뷰를 보자.</p>
<pre><code class="language-html">// resources/views/lessons/show.blade.php

&lt;article&gt;
  @include('lessons.partial.pager')
  &lt;!-- ... --&gt;
&lt;/article&gt;</code></pre>
<p>컨트롤러에서 넘겨 받은 <code>$prev</code>, <code>$next</code> 값이 <code>false</code> 일 경우, 즉 처음 페이지 또는 마지막 페이지일 경우, <code>class="disabled"</code> 속성을 지정하고 있다. 반면 값이 있을 경우에는, <code>route('lessons.show', '파일이름')</code> 으로 &quot;이전&quot; 또는 &quot;다음&quot; 으로 이동하는 링크를 만드는 것을 볼 수 있다.</p>
<pre><code>// resources/views/lessons/partial/pager.blade.php

&lt;nav&gt;
  &lt;ul class="pager"&gt;
    &lt;li class="previous {{ $prev === false ? 'disabled' : ''}}"&gt;
      &lt;a href="{{ $prev !== false ? route('lessons.show', $prev) : '#'}}"&gt;
        {{ trans('pagination.previous') }}
      &lt;/a&gt;
    &lt;/li&gt;
    &lt;li class="next {{ $next === false ? 'disabled' : ''}}"&gt;
      &lt;a href="{{ $next !== false ? route('lessons.show', $next) : '#' }}"&gt;
        {{ trans('pagination.next') }}
      &lt;/a&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;</code></pre>
<p>기존 강좌에서 넣어 두었던 마크다운을 이용한 이전 강좌, 다음 강좌 링크와 이번에 구현한 페이지네이션간의 중복을 피하기 위해, 기존 강좌의 마크다운 파일에 &lt;!--@start--&gt; &lt;!--@end--&gt; 와 같은 커스텀 마크다운 컴파일 규칙을 정의하고, 그것을 이해하고 처리하기 위해 'app/Services/Markdown.php' 도 약간 수정했다.</p>
<p><img src="./images/43-change-note-img-02.png" alt="" /></p>
<h4>Custom Artisan Command</h4>
<p>사용자의 요청이 없으면 강좌의 내용은 DB 에 Insert 되지 않는다. 그렇지만, 이미 DB 에 들어간 강좌의 마크다운 파일을, 다음 릴리즈 때 수정해서 올려야 한다면 어떻게 할까? 당연히 기존에 DB 에 들어가 있는 강좌 엔트리를 모두 업데이트해 줘야 한다. 사실 'lessons' 테이블을 truncate 하면 모든게 리셋되고, 새로 파일에서 읽어 DB Insert 를 하겠지만, 이렇게 하면 문제가 생긴다. 무슨 문제이고 하니, 댓글의 'commentable_id' 값이 이미 DB 에 들어간 강좌의 'id' 와 연결되어 있다는 점이다. 강좌의 변경 내용을 효율적으로 반영하기 위해 <a href="http://laravel.com/docs/5.2/artisan">커스텀 Artisan 코맨드</a> 를 만들자.</p>
<pre><code class="language-bash">$ php artisan make:console UpdateLessonsTable</code></pre>
<p>기본적으로 알고 있어야 할 것은 이 정도다. <code>$this-&gt;argument()</code> 로 콘솔에서 사용자가 입력한 인자를 얻을 수 있다. <code>$this-&gt;option()</code> 으로 콘솔에서 사용자가 입력한 옵션 값을 얻을 수 있다. <code>$this-&gt;info()</code>, <code>$this-&gt;error()</code>, <code>$this-&gt;warning()</code>, <code>$this-&gt;line()</code>, <code>$this-&gt;table()</code> 등으로 사용자에게 코맨드 실행결과를 알려 줄 수 있다. 사실 가장 중요한 것은 코맨드의 인자와 옵션을 지정하는 <code>$signature</code> 속성이다. 더 상세한 내용은 공식문서를 살펴볼 것을 권장한다. </p>
<pre><code class="language-php">// app/Console/Commands/UpdateLessonsTable.php

class UpdateLessonsTable extends Command
{
    protected $signature = 'my:update-lessons';

    protected $description = 'Update the content of the lessons table.';

    public function handle()
    {
        $lessons = \App\Lesson::all();

        foreach($lessons as $lesson) {
            $path = base_path(\App\Lesson::$path . DIRECTORY_SEPARATOR . $lesson-&gt;name);
            $lesson-&gt;content = \File::get($path);
            $lesson-&gt;save();
            $lesson-&gt;touch();

            $this-&gt;info(sprintf('Success updating %d: %s', $lesson-&gt;id, $lesson-&gt;name));
        }

        return $this-&gt;warn('Finished.');
    }
}</code></pre>
<p>Artisan 명령을 작성했으면 반드시 'app/Console/Kernel.php' 에 등록해 주어야 한다.</p>
<pre><code class="language-php">// app/Console/Kernel.php

class Kernel extends ConsoleKernel
{
    protected $commands = [
        \App\Console\Commands\UpdateLessonsTable::class,
    ];

    // ...
}</code></pre>
<p>실행해 보면 아래 그림과 같은 결과를 얻을 수 있다.</p>
<p><img src="./images/43-change-note-img-03.png" alt="" /></p>
<p><strong><code>참고</code></strong> 라라벨은 서버의 Crontab 정의를 직접 손대지 않고도, PHP 코드 레벨에서 작업 스케쥴을 정의할 수 있게 도와 준다. 공식 문서의 <a href="https://laravel.com/docs/5.2/scheduling">Task Scheduling</a> 부분을 살펴볼 것을 권장한다. 아래는 이 서비스에 적용되어 있는 월 단위 라라벨 로그를 삭제하는 스케쥴이다. 매일 3시에 DB 를 백업하는 코맨드도 넣어 두었다.</p>
<pre><code class="language-php">// app/Console/Commands/ClearLog.php

class ClearLog extends Command
{
    protected $signature = 'my:clear-log';

    protected $description = 'Clear Laravel log.';

    public function handle()
    {
        $path = storage_path('logs/laravel.log');
        system('cat /dev/null &gt; ' . $path);

        $now = \Carbon\Carbon::now()-&gt;toDateTimeString();
        $result = "{$this-&gt;getName()} command done at {$now}";
        \Log::info($result);

        return $this-&gt;info($result);
    }
}</code></pre>
<pre><code class="language-php">// app/Console/Kernel.php

class Kernel extends ConsoleKernel
{
    // ...

    protected function schedule(Schedule $schedule)
    {
        $schedule-&gt;command('inspire')-&gt;hourly();
        $schedule-&gt;command('my:clear-log')-&gt;monthly();
        $schedule-&gt;command(
                sprintf('my:backup-db %s %s', env('DB_USERNAME'), env('DB_PASSWORD'))
            )-&gt;dailyAt('03:00');
    }
}</code></pre>
<h3>3. 라이브 데모 사이트 개설</h3>
<h4>라이브 데모 사이트</h4>
<p>AWS 에 오픈했다.</p>
<p><img src="./images/43-change-note-img-04.png" alt="" /></p>
<h4>Envoy SSH Task Runner</h4>
<p><a href="http://laravel.com/docs/envoy">Envoy</a> 는 라라벨에서 제공하는 Remote Task Runner 이다. 원격 서버에 SSH 로 직접 로그인하지 않고도, 스크립트로 써 놓은 Task 를 <strong>&quot;로컬&quot;</strong> 에서 실행할 수 있는 기능이다. Envoy 는 <a href="http://www.puppetlabs.com/">Puppet</a>, <a href="https://www.chef.io/">Chef</a> 와 같은 프로비저닝 툴도 아니고, <a href="https://github.com/capistrano/capistrano/wiki">Capistrano</a>, <a href="https://github.com/deployphp/deployer">Deployer</a> 와 같은 배포 툴과도 결이 다르다. 앞서 나열한 목적이 명확한 고차원적인 애들 보다는 훨신 더 저수준 (== Low Level) 이고, 그만큼 자유도가 높다는 뜻이다. 이야기인 즉, 프로비저닝 용도로도 쓸 수 있고, 배포 용도로도 쓸 수 있고, 일반적인 관리 작업 용도로도 쓸 수 있다는 말이다. 파이썬으로 만들어진 <a href="https://github.com/fabric/fabric">fabric/fabric</a> 과 가장 유사하다고 할 수 있다.</p>
<p>Envoy 를 사용하기 위해 가장 먼저 해야 하는 일은 Envoy 를 설치하는 일이다.</p>
<pre><code class="language-bash">$ composer global require "laravel/envoy=~1.0"</code></pre>
<pre><code class="language-bash"># 사용하는 Shell 에 따라 Profile 파일 이름은 다를 수 있다. 
# 필자는 Zshell 을 쓰므로, .zshrc 이다. e.g. .profile, .bashrc
$ nano ~/.zshrc

# composer global 로 설치한 패키지들의 실행파일을 경로에 넣어 준다.
# 이 과정이 없다면 $ ~/.composer/vendor/bin/envoy 와 같이 전체 경로를 써주어야 한다.
export PATH="$PATH:$HOME/.composer/vendor/bin"

# 수정했다면 ctrl + X, "Y" 를 눌러 변경 내용을 저장하고, 엔터를 한번 더 눌러 기존 파일을 덮어 쓴다.

# 그리고, 수정 내용을 현재 콘솔에 적용해 준다. 콘솔을 껐다가 다시 실행해도 된다.
$ source ~/.zshrc</code></pre>
<p>로컬에 설치된 Ubuntu VM을 원격 서버라 가정하고, 여기에 접속해서 터미널에서 'hello' 를 찍는 간단한 스크립트만 짜 볼 것이다. 독자들께서는 사용하시는 원격 서버의 정보를 직접 입력하여 테스트해 보시기 바란다. 여기서 재밌는 부분은 블레이드와 유사한 문법을 이용할 수 있다는 점이다.</p>
<pre><code class="language-bash">// Envoy.blade.php

@servers(['homestead' =&gt; 'homestead.vm'])

@task('hello', ['on' =&gt; 'homestead'])
  echo "Hello Envoy!";
@endtask</code></pre>
<p>필자는 원격 서버에 사용자 이름 및 키 파일 지정없이 <code>$ ssh 원격서버주소</code> 만으로 접속할 수 있도록 아래와 같이 '~/.ssh/config' 를 항상 지정한다. 이 과정이 없다면 <code>$ ssh -i 키파일위치 사용자이름@원격서버주소</code> 식으로 로그인해야 한다. '~/.ssh/config' 를 정의하자.</p>
<pre><code class="language-bash">$ nano ~/.ssh/config

Host homestead.vm
    HostName homestead.vm
    User vagrant
    IdentityFile ~/.ssh/id_rsa

# 수정을 완료한 후 ctrl + X -&gt; Y -&gt; Enter.</code></pre>
<p><code>$ envoy run hello</code> 를 실행하면 아래 그림과 같이 원격 서버에 접속해서 명령을 수행하고 결과를 로컬로 다시 돌려준 것을 확인할 수 있을 것이다.</p>
<p><img src="./images/43-change-note-img-05.png" alt="" /></p>
<h4># slack 을 활용한 Error Reporting</h4>
<p><a href="https://bugsnag.com/">BugSnag</a> 과 같은 에러 관리 도구를 이용하면 좋겠지만 관리 도구는 항상 비용을 수반하게 된다. 소속한 개발팀에서 슬랙, 힙챗, 텔레그램과 같이 수시로 들여다 보는 커뮤니케이션 도구가 있다면, 원격 서버에서 발생하는 에러를 모니터링 하기에는 더 없이 좋은 도구이다. 여기서는 필자가 사용하는 <a href="https://slack.com/"># slack</a> 을 이용할 것이다.</p>
<p>PHP 자체는 Fatal Error 가 발생하지 않는 한 실행을 멈추지 않고 다음 코드를 실행하는 식으로 예외에 대해 관대한 편이다. 심지어 변수가 정의되지 않았을 때도 Warning 만 발생시키고 죽지 않는다. 하지만, 라라벨은 모든 Error 를 Exception 으로 던지게 구조화되어 있고, 기본기 강좌 <a href="24-exception-handling.md">24강 - 예외 처리</a> 에서 살펴본 바와 같이 'app/Exceptions/Handler.php' 에서 이들을 캐치하고 있다. 즉 # slack 으로 예외를 보고하기 위해서는 'Handler.php' 에서 관련 코드를 추가하면 된다는 의미이다. </p>
<pre><code class="language-php">// app/Exceptions/Handler.php

class Handler extends ExceptionHandler
{
    public function report(Exception $e)
    {
        if ($this-&gt;shouldReport($e) and app()-&gt;environment('production')) {
            app(\App\Reporters\ErrorReport::class, [$e])-&gt;send();
        }

        //...
    }
}</code></pre>
<p>그 다음은 # slack 메시지를 보내는 방법을 찾아야 하는데, <a href="https://github.com/maknz/slack">maknz/slack</a> 와 같은 외부 라이브러리를 이용하는 방법과, 라라벨에 기본 내장된 <a href="https://github.com/Seldaek/monolog">monolog/monolog</a> 를 이용하는 방법이 있다. 여기서는 maknz/slack 을 이용했다. monolog 를 이용한 구현도 'app/Reporters/MonologSlackReport.php' 에 있다.</p>
<pre><code class="language-bash">$ composer require "maknz/slack:1.*"

# ServiceProvider, Facade, config 등은 패키지의 문서를 참고하자.</code></pre>
<p>위 'Handler.php' 코드에서 본 바와 같이 <code>ErrorReport</code> 란 클래스를 만들고, 거기에 <code>send()</code> 라는 API 를 정의한 것을 알 수 있다.</p>
<pre><code class="language-php">// app/Reporters/ErrorReport.php

&lt;?php

namespace App\Reporters;

use ...

class ErrorReport
{
    private $client;

    private $primitive;

    public function __construct(\Exception $e, $webhook = '', $settings = [])
    {
        $this-&gt;primitive = $e;
        $webhook = $webhook ?: env('SLACK_WEBHOOK');
        $this-&gt;createClient($webhook, $settings);
    }

    public function send()
    {
        return $this-&gt;client-&gt;createMessage()-&gt;attach($this-&gt;buildPayload())-&gt;send();
    }

    protected function buildPayload()
    {
        return new Attachment([
            'fallback' =&gt; 'Error Report',
            'text'     =&gt; $this-&gt;primitive-&gt;getMessage() ?: "Something broken :(",
            'color'    =&gt; 'danger',
            'fields'   =&gt; [
                new AttachmentField([
                    'title' =&gt; 'localtime',
                    'value' =&gt; Carbon::now('Asia/Seoul')-&gt;toDateTimeString(),
                ]),
                // ...
            ],
        ]);
    }

    protected function createClient($webhook, $overrides = [])
    {
        $settings = array_merge([
            'channel'                 =&gt; '#l5essential',
            'username'                =&gt; 'aws-demo',
            'link_names'              =&gt; true,
            'unfurl_links'            =&gt; true,
            'markdown_in_attachments' =&gt; ['title', 'text', 'fields'],
        ], $overrides);

        return $this-&gt;client = new Client($webhook, $settings);
    }
}</code></pre>
<p>테스트를 위해 'Handler.php' 에서 <code>APP_ENV == 'production'</code> 일 때만 리포팅 하도록 한 <code>if ($this-&gt;shouldReport($e) and app()-&gt;environment('production')) {</code> 부분을 잠깐 주석 처리 하고, <code>App\Http\Controllers\WelcomeController::index()</code> 메소드에서 없는 뷰를 반환하도록 하고 홈 페이지를 방문하였다. 결과는 아래 그림과 같다.</p>
<p><img src="./images/43-change-note-img-06.png" alt="" /></p>
<!--@start-->
<hr />
<ul>
<li><a href="../readme.md">목록으로 돌아가기</a></li>
<li><a href="42-be-makeup.md">42강 - 서버 사이드 개선</a>
<!--@end--></li>
</ul>

            <hr/>

            <nav id="pagination">
  <ul class="pager pager-bottom">
    <li class="previous ">
      <a href="/lessons/42-be-makeup.html">
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_left</i>
        </span>
        <span class="pager-title">
          42강 - 서버 사이드...
        </span>
      </a>
    </li>
    <li class="next ">
      <a href="/lessons/44-api-basic.html">
        <span class="pager-title">
          44강 - API 기본기 및...
        </span>
        <span class="pager-title-sm">
          <i class="material-icons">keyboard_arrow_right</i>
        </span>
      </a>
    </li>
  </ul>
</nav>                  </article>

        <hr class="divider">

        <div id="comment">
          <div class="comments" style="margin-bottom: 30px;">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//l5lessons.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  <!--script id="dsq-count-scr" src="//l5lessons.disqus.com/count.js" async></script-->
</div>        </div>
      </div>
    </div>
  </div>

  <div id="toggler">
    <a href="#" title="Open Menu">
      목록 토글
    </a>
  </div>

  <footer id="footer">
  <div>
    &copy; 2016 &nbsp; <a href="https://github.com/appkr">appkr</a> •
    Built with <a href="http://jigsaw.tighten.co/">Jigsaw</a> •
    Hosted by <a href="https://pages.github.com/">Github</a> •
    <a href="/feed.xml">Rss</a>
  </div>
</footer>

<div id="back-to-top">
  <a href="#" title="Scroll to Top">
    <i class="material-icons">keyboard_arrow_up</i>
  </a>
</div>
  <script src="/js/all.js"></script>
</body>
</html>
